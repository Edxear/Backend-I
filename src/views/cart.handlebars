<div class="cart-container">
  <h1>Mi Carrito</h1>
  <a href="/products" class="btn btn-secondary">← Continuar comprando</a>

  {{#if cart.products}}
    <table class="cart-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Precio</th>
          <th>Cantidad</th>
          <th>Subtotal</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {{#each cart.products}}
          <tr data-product-id="{{this.product._id}}">
            <td>
              <a href="/products/{{this.product._id}}">{{this.product.title}}</a>
            </td>
            <td>${{this.product.price}}</td>
            <td>
              <input type="number" class="quantity-input" value="{{this.quantity}}" min="1" 
                     data-product-id="{{this.product._id}}" />
            </td>
            <td class="subtotal">${{multiply this.product.price this.quantity}}</td>
            <td>
              <button class="btn-delete" data-product-id="{{this.product._id}}">Eliminar</button>
            </td>
          </tr>
        {{/each}}
      </tbody>
    </table>

    <div class="cart-summary">
      <h3>Resumen del Carrito</h3>
      <p><strong>Total de items:</strong> {{cart.products.length}}</p>
      <p class="total"><strong>Total:</strong> $<span id="totalPrice">{{calcTotal cart.products}}</span></p>
      
      <div class="cart-actions">
        <button id="emptyCartBtn" class="btn btn-danger">Vaciar carrito</button>
        <button id="checkoutBtn" class="btn btn-primary btn-large">Realizar compra</button>
      </div>
    </div>
  {{else}}
    <div class="empty-cart">
      <h2>Tu carrito está vacío</h2>
      <p>Aún no has agregado ningún producto.</p>
      <a href="/products" class="btn btn-primary btn-large">Ir a comprar</a>
    </div>
  {{/if}}
</div>

<script>
  const cartId = '{{cart._id}}';

  // Actualizar cantidad
  document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('change', async (e) => {
      const productId = e.target.getAttribute('data-product-id');
      const quantity = parseInt(e.target.value);

      if (quantity < 1) {
        e.target.value = 1;
        return;
      }

      try {
        const response = await fetch(`/api/carts/${cartId}/product/${productId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity })
        });

        if (response.ok) {
          location.reload();
        } else {
          alert('Error al actualizar la cantidad');
        }
      } catch (err) {
        console.error('Error:', err);
      }
    });
  });

  // Eliminar producto
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const productId = e.target.getAttribute('data-product-id');

      if (!confirm('¿Estás seguro de que deseas eliminar este producto?')) return;

      try {
        const response = await fetch(`/api/carts/${cartId}/product/${productId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          location.reload();
        } else {
          alert('Error al eliminar el producto');
        }
      } catch (err) {
        console.error('Error:', err);
      }
    });
  });

  // Vaciar carrito
  document.getElementById('emptyCartBtn')?.addEventListener('click', async () => {
    if (!confirm('¿Estás seguro de que deseas vaciar el carrito?')) return;

    try {
      const response = await fetch(`/api/carts/${cartId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        location.reload();
      } else {
        alert('Error al vaciar el carrito');
      }
    } catch (err) {
      console.error('Error:', err);
    }
  });

  // Realizar compra (placeholder)
  document.getElementById('checkoutBtn')?.addEventListener('click', () => {
    alert('Funcionalidad de compra próximamente');
  });
</script>

<style>
  .cart-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }

  .cart-table {
    width: 100%;
    border-collapse: collapse;
    margin: 30px 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .cart-table th,
  .cart-table td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  .cart-table th {
    background: #3498db;
    color: white;
    font-weight: bold;
  }

  .cart-table tr:hover {
    background: #f9f9f9;
  }

  .quantity-input {
    width: 80px;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  .subtotal {
    font-weight: bold;
  }

  .btn-delete {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
  }

  .btn-delete:hover {
    background: #c0392b;
  }

  .cart-summary {
    background: #ecf0f1;
    padding: 20px;
    border-radius: 5px;
    max-width: 400px;
    margin-left: auto;
  }

  .total {
    font-size: 1.5em;
    color: #2ecc71;
    margin: 15px 0;
  }

  .cart-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .btn-danger {
    background: #e74c3c;
    color: white;
  }

  .btn-danger:hover {
    background: #c0392b;
  }

  .empty-cart {
    text-align: center;
    padding: 60px 20px;
    background: #f9f9f9;
    border-radius: 5px;
  }

  .btn {
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
  }

  .btn-primary {
    background: #3498db;
    color: white;
  }

  .btn-secondary {
    background: #95a5a6;
    color: white;
  }

  .btn-large {
    padding: 12px 30px;
    font-size: 1.1em;
  }
</style>
